---
description: 工程化开发流程总纲 — 从需求到上线的完整规范
alwaysApply: true
---

# 工程化开发流程

所有开发工作必须遵循以下完整流程。不允许跳过任何阶段。

## 阶段一：需求定义

接到任何开发任务时，先明确以下内容再动手写代码：

1. **需求范围** — 这次改什么？涉及哪些页面/接口？边界在哪？
2. **影响分析** — 改动会影响哪些现有功能？是否有破坏性变更？
3. **验收标准** — 怎么算做完？列出具体的可验证条件
4. **用 TodoWrite 建立任务清单** — 将需求拆解为可执行的子任务

示例：
```
需求：添加记录编辑功能
范围：后端 records 路由 + 前端 add 页面复用
影响：records 列表页需要加编辑入口，提醒页的记录也要能编辑
验收标准：
  - 后端 PUT /api/records/:id 接口可用
  - 前端可从记录列表进入编辑模式
  - 编辑后数据正确保存
  - 冒烟测试补充编辑用例并全部通过
```

## 阶段二：架构设计

对于涉及多文件、新页面、新接口的需求，先设计再编码：

1. **数据流设计** — 数据从哪来、怎么流转、存到哪
2. **接口设计** — 新增/修改的 API 路径、参数、返回值
3. **页面/组件设计** — 新增页面的结构、复用哪些组件
4. **数据库变更** — 是否需要新增表/字段，是否需要数据迁移

设计输出记录在当次对话中，重要的架构决策同步更新到 `project-context.mdc`。

### 架构原则

- **简洁优先** — 用最少的代码实现需求，拒绝过度设计
- **模块解耦** — 每个文件/函数只做一件事，模块之间通过清晰的接口通信，不互相侵入
- **不写无效代码** — 不留 dead code、不写用不到的函数、不加"以防万一"的冗余逻辑
- **可追溯** — 每一行改动都要能回答"为什么改"，通过注释和 commit message 追溯决策过程

## 阶段三：编码实现

1. **按任务清单逐个完成** — 每完成一个子任务标记 completed
2. **先后端后前端** — API 先写好测试通过，再对接前端
3. **遵循代码注释规范** — 参见 `code-comments.mdc`
4. **每个文件改完检查 lint** — 用 ReadLints 工具检查
5. **新增 API 必须补测试** — 在 `smoke.test.js` 中添加对应用例

### 变更可追溯性要求

每次修改代码时，必须让改动可追溯：

1. **改之前先说明** — 在对话中向用户解释：要改哪个文件、改什么、为什么要改
2. **代码内注释** — 对非显而易见的改动，在代码中写明原因（参见注释规范）
3. **commit message** — 提交信息要准确反映改了什么和为什么
4. **CHANGELOG** — 用户可感知的变更必须记录

**禁止黑盒操作**：不允许不解释就大面积修改代码。修改多个文件时，逐个说明每个文件改了什么、改动的原因。

### 代码质量底线

- **不输出无效代码** — 不写 console.log 调试代码（除非有意义的错误日志）、不写注释掉的废弃代码、不写空函数占位
- **不做无意义的重构** — 如果现有代码能工作且可维护，不要为了"更好看"而重写
- **不引入不需要的依赖** — 每加一个 npm 包都要有明确理由
- **最小改动原则** — 能改一行解决的问题，不要改十行

## 阶段四：测试验证

```bash
cd /Users/mango/projects/pet-health-mp/server && npm test
```

- **全部用例通过**才能进入下一步（当前 64 条，随迭代增长）
- 测试失败 → 修复代码 → 重新测试，不允许跳过
- 如果改了前端，在微信开发者工具中手动验证核心流程

## 阶段五：记录与提交

1. **更新 CHANGELOG.md** — 记录本次变更（新增/修复/变更/移除）
2. **更新 iteration-plan.mdc** — 完成的任务打勾，新发现的问题加入
3. **更新 project-context.mdc** — 如有架构变更（新页面/新接口/新表）必须同步
4. **Git 提交**：
   ```bash
   cd /Users/mango/projects/pet-health-mp
   git add -A
   git commit -m "type: 中文描述"
   ```
   type 使用：feat（新功能）/ fix（修复）/ refactor（重构）/ chore（杂项）/ docs（文档）

## 阶段六：推送发布

```bash
export ALL_PROXY=http://127.0.0.1:7897
git push
```

如需更新线上后端服务：
```bash
# 本地执行，同步代码到服务器
ssh root@43.156.90.252 "cd /opt/pet-health/server && git pull && npm install && pm2 restart pet-health-api"
```

如需更新小程序：
- 微信开发者工具 → 编译 → 上传 → 公众平台设为体验版

## 安全红线

- **禁止提交** `.env`、`*.db`、`node_modules/`
- **禁止** `git push --force` 到 main 分支
- **禁止**跳过测试直接提交
- **禁止**在没有明确需求的情况下大规模重构

## 流程速查

```
需求定义 → 架构设计 → 编码实现 → 冒烟测试 → 变更记录 → 提交推送
```
