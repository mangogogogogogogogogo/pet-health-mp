---
description: 需求分析与架构设计规范 — 动手前先想清楚
alwaysApply: true
---

# 需求分析与架构设计规范

**核心原则：先想清楚再动手，避免写了拆、拆了写。**

## 一、需求分析模板

收到开发任务时，先输出以下内容（在对话中展示给用户确认）：

```
### 需求分析

**需求描述**: 一句话概括
**需求类型**: 新功能 / 缺陷修复 / 体验优化 / 技术重构
**涉及模块**:
  - 前端: 哪些页面/组件
  - 后端: 哪些路由/中间件
  - 数据库: 是否需要变更表结构

**影响范围**:
  - 直接影响: 改动的文件
  - 间接影响: 依赖这些文件的其他功能

**验收标准**:
  1. 具体可验证的条件
  2. ...

**预估改动量**: 小（1-3个文件）/ 中（4-8个文件）/ 大（8个以上）
```

## 二、架构设计要求

### 什么时候需要做设计

- 新增页面或 API 路由
- 修改数据库表结构
- 改动涉及 3 个以上模块的联动
- 引入新的技术方案或第三方依赖

### 设计输出内容

1. **接口设计**（如有新增/修改 API）：
   ```
   PUT /api/records/:id
   请求参数: { record_name, record_date, next_date, ... }
   返回格式: { success: true, data: { ...更新后的记录 } }
   权限: 需要 openId 鉴权，只能编辑自己的记录
   ```

2. **数据流向图**（复杂功能）：
   ```
   用户操作 → 前端事件 → app.request() → 后端路由 → 数据库操作 → 返回结果 → 前端更新视图
   ```

3. **页面结构**（如有新增页面）：
   - 页面路径、是否加入 TabBar
   - 页面 data 结构
   - 生命周期调用哪些方法

4. **数据库变更**（如有）：
   - ALTER TABLE 语句
   - 是否需要迁移旧数据
   - 是否需要新索引

## 三、版本管理规范

### 版本号规则（语义化版本）

- **主版本号** (X.0.0): 不兼容的重大变更（如数据库迁移、API 破坏性变更）
- **次版本号** (0.X.0): 新增功能（向后兼容）
- **修订号** (0.0.X): 缺陷修复、样式调整、注释优化

### Git 分支策略

当前项目单人开发，使用简化策略：
- `main` 分支 = 生产代码，始终保持可部署状态
- 大功能可以用 feature 分支，完成后合并回 main

### 提交信息规范

格式: `type: 中文描述`

| type | 用途 | 示例 |
|------|------|------|
| feat | 新功能 | `feat: 新增记录编辑功能` |
| fix | 修复缺陷 | `fix: 修复提醒日期计算错误` |
| refactor | 重构（不改功能） | `refactor: 抽取宠物卡片为公共组件` |
| style | 样式调整 | `style: 统一表单输入框圆角` |
| chore | 构建/依赖/配置 | `chore: 升级 express 到 4.22` |
| docs | 文档/注释 | `docs: 补充后端路由注释` |
| test | 测试 | `test: 补充记录编辑接口测试` |

### CHANGELOG 维护

每次版本更新在 `CHANGELOG.md` 顶部追加，按 Keep a Changelog 格式分类：
- **新增 (Added)**: 新功能
- **修复 (Fixed)**: 缺陷修复
- **变更 (Changed)**: 功能变更
- **移除 (Removed)**: 删除的功能

## 四、迭代过程记录

每次迭代开发过程中：

1. **开发前**: 用 TodoWrite 创建任务清单，标记 in_progress
2. **开发中**: 每完成一个子任务立即标记 completed
3. **开发后**: 更新 `iteration-plan.mdc` 中对应的 checkbox
4. **重要决策**: 如果开发中做了架构取舍（如"选 A 方案而非 B 方案"），在代码注释或 CHANGELOG 中记录原因

## 五、代码审查清单

提交前自查：

- [ ] 需求范围内的功能是否都实现了
- [ ] 是否有遗漏的边界情况处理
- [ ] 新增的 API 是否补了冒烟测试
- [ ] 关键逻辑是否有中文注释
- [ ] 文件头注释是否更新
- [ ] CHANGELOG 是否记录了变更
- [ ] project-context.mdc 是否需要同步更新（新页面/新接口/新表）
